"use strict";(self.webpackChunkAVTranscoder=self.webpackChunkAVTranscoder||[]).push([[257],{52257:(t,e,i)=>{i.r(e),i.d(e,{default:()=>b});var r=i(134),n=i(63939),a=i(51597),s=i(4624),o=i(9705),c=i(89088),f=i(77231),d=i(43607),h=i(75294),g=i(31608),l=i(729),x=i(19028),u=i(14686),w=i(50011),p=i(95335),m="src/avformat/formats/OMp3Format.ts";const T={id3v2Version:4,hasID3v1:!1,hasXing:!0};class b extends a.A{constructor(t={}){super(),(0,r.A)(this,"type",8),(0,r.A)(this,"options",void 0),(0,r.A)(this,"context",void 0),(0,r.A)(this,"xingWriter",void 0),this.options=p.X$({},T,t)}init(t){return t.ioWriter.setEndian(!0),this.context={size:0,frames:0,seen:0,want:1,bag:[],pos:0,initialBitrate:0,hasVariableBitrate:!1,padding:0,delay:0,frameHeader:new h.Vz,xingOffset:-1,xingFrameSize:0,xingFrameOffset:BigInt(0),xingFramePos:BigInt(0),audioSize:0,id3SizePos:BigInt(0)},this.xingWriter=new l.A(new Uint8Array(5e3)),t.streams.find((t=>86017===t.codecpar.codecId))?0:(s.z3("can not found stream with mp3 codec",m,125),o.UY)}writeXingTag(t){if(!this.options.hasXing)return;const e=t.streams.find((t=>86017===t.codecpar.codecId));let i=-1,r=0,n=-1,a=-1,o=BigInt(f.go>>>0),l=0,x=0;const u=[44100,48e3,32e3];for(let t=0;t<u.length;t++){const r=u[t];if(e.codecpar.sampleRate===r)l=3;else if(e.codecpar.sampleRate===r/2)l=2;else{if(e.codecpar.sampleRate!==r/4)continue;l=0}i=t}if(i===u.length)return void s.R8("unsupported sample rate, not writing Xing header.",m,171);switch(e.codecpar.chLayout.nbChannels){case 1:r=3;break;case 2:r=0;break;default:return void s.R8("unsupported number of channels, not writing Xing header.",m,185)}let p=-16777216;for(p|=(227|l<<3)<<16,p|=i<<2<<8,p|=r<<6,n=1;n<15;n++){let t=BigInt(Math.floor(1e3*c.oz(l,2,n))),i=d.tn(t-e.codecpar.bitRate);i<o&&(o=i,a=n)}for(n=a;;n++){let t=n<<12;if(15==n)return;p|=t,h.qg(this.context.frameHeader,p);const i=[[0,9,17],[0,0,0],[0,9,17],[0,17,32]];if(this.context.xingOffset=i[this.context.frameHeader.version][e.codecpar.chLayout.nbChannels]+4,x=this.context.xingOffset+g.FN,x<=h.CM(this.context.frameHeader,e.codecpar.sampleRate))break;p&=~t}this.xingWriter.writeUint32(p),this.xingWriter.writeBuffer(new Uint8Array(this.context.xingOffset-4).fill(0)),this.xingWriter.writeString("Xing"),this.xingWriter.writeUint32(15),this.context.size=h.CM(this.context.frameHeader,e.codecpar.sampleRate),this.context.want=1,this.context.seen=0,this.context.pos=0,this.xingWriter.writeUint32(0),this.xingWriter.writeUint32(0);for(let t=0;t<g.W8;t++)this.xingWriter.writeUint8(255*t/g.W8>>>0);this.xingWriter.writeUint32(0);const T=e.metadata;if(null!=T&&T.encoder){const t=w.l(T.encoder);this.xingWriter.writeBuffer(t.subarray(0,9))}else this.xingWriter.writeString("Lavf"),this.xingWriter.writeBuffer(new Uint8Array(5).fill(0));this.xingWriter.writeUint8(0),this.xingWriter.writeUint8(0),this.xingWriter.writeBuffer(new Uint8Array(8).fill(0)),this.xingWriter.writeUint8(0),this.xingWriter.writeUint8(0),this.xingWriter.writeUint24(0),this.xingWriter.writeUint8(0),this.xingWriter.writeUint8(0),this.xingWriter.writeUint16(0),this.xingWriter.writeUint32(0),this.xingWriter.writeUint16(0),this.xingWriter.writeUint16(0),this.xingWriter.writeBuffer(new Uint8Array(this.context.size-x).fill(0)),this.context.xingFrameSize=this.xingWriter.getPos(),this.context.xingFrameOffset=t.ioWriter.getPos(),t.ioWriter.writeBuffer(this.xingWriter.getWroteBuffer()),this.context.audioSize=this.context.xingFrameSize}xingAddFrame(t){if(this.context.frames++,this.context.seen++,this.context.size+=n.f[15](t+28),this.context.want===this.context.seen){if(this.context.bag[this.context.pos]=this.context.size,400==++this.context.pos){for(let t=1;t<400;t+=2)this.context.bag[t>>1]=this.context.bag[t];this.context.want*=2,this.context.pos=200}this.context.seen=0}}updateXing(t){this.context.hasVariableBitrate&&(this.xingWriter.seek(this.context.xingOffset),this.xingWriter.writeString("Info")),this.xingWriter.seek(this.context.xingOffset+8),this.xingWriter.writeUint32(this.context.frames),this.xingWriter.writeUint32(this.context.size),this.xingWriter.seek(this.context.xingFrameSize);const e=this.xingWriter.getWroteBuffer().subarray(this.context.xingOffset+16);e[0]=0;for(let t=1;t<g.W8;t++){let i=t*this.context.pos/g.W8>>>0;const r=256*this.context.bag[i]/this.context.size>>>0;e[t]=Math.min(r,255)}const i=t.ioWriter.getPos();t.ioWriter.seek(this.context.xingFrameOffset),t.ioWriter.writeBuffer(this.xingWriter.getWroteBuffer()),t.ioWriter.seek(i)}writeHeader(t){const e=t.streams.find((t=>86017===t.codecpar.codecId));return this.options.id3v2Version&&x.M(t.ioWriter,this.options.id3v2Version,t.metadataHeaderPadding,e.metadata),this.options.hasXing&&this.writeXingTag(t),0}writeAVPacket(t,e){if(!n.f[15](e+28))return void s.R8(`packet's size is 0: ${n.f[15](e+32)}, ignore it`,m,368);const i=t.getStreamByIndex(n.f[15](e+32));if(i){if(86017===i.codecpar.codecId){if(n.f[20](e+24)&&n.f[15](e+28)>4){h.qg(this.context.frameHeader,n.f[8](n.f[20](e+24)));const i=c.oz(this.context.frameHeader.version,this.context.frameHeader.layer,this.context.frameHeader.bitrateIndex);this.context.initialBitrate?i!==this.context.initialBitrate&&(this.context.hasVariableBitrate=!0):this.context.initialBitrate=i,this.xingAddFrame(e),t.ioWriter.writeBuffer((0,u.s3)(n.f[20](e+24),n.f[15](e+28)))}return 0}s.R8(`packet's codecId is not mp3: ${n.f[15](e+32)}, ignore it`,m,380)}else s.R8(`can not found the stream width the packet's streamIndex: ${n.f[15](e+32)}, ignore it`,m,375)}writeTrailer(t){if(this.options.hasID3v1){const e=t.streams.find((t=>86017===t.codecpar.codecId)).metadata,i=new Uint8Array(g.c1),r=new l.A(i);function n(t){const e=w.l(t);r.writeBuffer(e.subarray(0,30)),e.length<30&&r.skip(30-e.length)}r.writeString("TAG"),e.title?n(e.title):r.skip(30),e.artist?n(e.artist):r.skip(30),e.album?n(e.album):r.skip(30),i[127]=255,e.genre&&(i[127]=+e.genre),t.ioWriter.writeBuffer(i)}return this.options.hasXing&&this.updateXing(t),t.ioWriter.flush(),0}flush(t){return t.ioWriter.flush(),0}}},75294:(t,e,i)=>{i.d(e,{CM:()=>o,Vz:()=>a,qg:()=>s});var r=i(134),n=i(89088);class a{constructor(){(0,r.A)(this,"version",void 0),(0,r.A)(this,"layer",void 0),(0,r.A)(this,"protection",void 0),(0,r.A)(this,"bitrateIndex",void 0),(0,r.A)(this,"samplingFrequency",void 0),(0,r.A)(this,"padding",void 0),(0,r.A)(this,"private",void 0),(0,r.A)(this,"mode",void 0),(0,r.A)(this,"modeExtension",void 0),(0,r.A)(this,"copyright",void 0),(0,r.A)(this,"original",void 0),(0,r.A)(this,"emphasis",void 0)}}function s(t,e){t.version=e>>19&3,t.layer=e>>17&3,t.protection=e>>16&1,t.bitrateIndex=e>>12&15,t.samplingFrequency=e>>10&3,t.padding=e>>9&1,t.mode=e>>6&3,t.modeExtension=e>>4&3,t.copyright=e>>3&1,t.original=e>>2&1,t.emphasis=3&e}function o(t,e){let i=n.oz(t.version,t.layer,t.bitrateIndex);switch(t.layer){case 1:default:i=144e3*i/(e<<(3===t.version?0:1))>>>0,i+=t.padding;break;case 2:i=144e3*i/e>>>0,i+=t.padding;break;case 3:i=12e3*i/e>>>0,i=4*(i+t.padding)}return i}},19028:(t,e,i)=>{i.d(e,{M:()=>c,q:()=>o});var r=i(4624),n=i(50011),a="src/avformat/formats/mp3/id3v2.ts";function s(t,e){let i="utf-8";return 0===t?i="iso-8859-1":1===t?i="utf-16":2===t&&(i="utf-16be"),new TextDecoder(i).decode(e)}async function o(t,e,i,n){const o=2!==i.version,c=o?10:6;let f=t.getPos()+BigInt(e>>>0);async function d(){await t.seek(f)}if(o&&64&i.flags){let n=await async function(t,e){let i=0;for(;e--;)i=(i<<7)+(127&await t.readUint8());return i}(t,4);if(4===i.version&&(n-=4),n<0)return r.z3("invalid extended header length",a,92),await d();if(await t.skip(n),(e-=n+4)<0)return r.z3("extended header too long",a,98),await t.seek(f),await d()}for(;e>c;){let i,f;if(o){if(i=await t.readString(4),f=await t.readUint32(),!f){r.z3("invalid frame size",a,112);break}await t.readUint16()}else i=await t.readString(3),f=await t.readUint24();if("APIC"===i)n.poster=await t.readBuffer(f);else if("USLT"===i){const e=await t.readUint8(),i=await t.readString(3),r=await t.readBuffer(f-4);n.lyrics=`${i} ${s(e,r)}`}else if("COMM"===i||"COM"===i){const e=await t.readUint8(),i=await t.readString(3),r=await t.readBuffer(f-4);n.comment=`${i} ${s(e,r)}`}else{let e;switch(e="T"===i[0]?s(await t.readUint8(),await t.readBuffer(f-1)):await t.readBuffer(f),i){case"TIT2":case"TT2":n.title=e;break;case"TPE1":case"TP1":n.artist=e;break;case"TPE2":case"TP2":n.albumArtist=e;break;case"TPOS":n.disc=e;break;case"TCOP":n.copyright=e;break;case"TALB":case"TAL":n.album=e;break;case"TRCK":case"TRK":n.track=e;break;case"TYER":case"TDRL":case"TDRC":n.date=e;break;case"COMM":case"COM":n.comment=e;break;case"TCON":case"TCO":n.genre=e;break;case"TSSE":case"TEN":n.encoder=e;break;case"TCOM":n.composer=e;break;case"TENC":n.encodedBy=e;break;case"TLAN":n.language=e;break;case"TPE3":case"TP3":n.performer=e;break;case"TPUB":n.publisher=e;break;case"TCMP":case"TCP":n.compilation=e;break;case"TDEN":n.creationTime=e;break;case"TSOA":n.albumSort=e;break;case"TSOP":n.artistSort=e;break;case"TSOT":n.titleSort=e;break;case"TIT1":n.grouping=e;break;default:n[i]=e}}e-=f+c}4==i.version&&16&i.flags&&(f+=BigInt(10)),await t.seek(f)}function c(t,e,i,r){let a=t.getPos();t.writeString("ID3"),t.writeUint8(e),t.writeUint16(0);const s=t.getPos();function o(e,i){const r=n.l(i);t.writeString(e),t.writeUint32(r.length+1),t.writeUint16(0),t.writeUint8(3),t.writeBuffer(r)}var c;if(t.writeUint32(0),r.poster&&("APIC",c=r.poster,t.writeString("APIC"),t.writeUint32(c.length),t.writeUint16(0),t.writeBuffer(c)),r.title&&o("TIT2",r.title),r.artist&&o("TPE1",r.artist),r.albumArtist&&o("TPE2",r.albumArtist),r.disc&&o("TPOS",r.disc),r.copyright&&o("TCOP",r.copyright),r.album&&o("TALB",r.album),r.track&&o("TRCK",r.track),r.date&&o("TDRC",r.date),r.comment){let t=r.comment;" "===t[3]&&(t=t.slice(0,3)+t.slice(4)),o("COMM",t)}if(r.lyrics){let t=r.lyrics;" "===t[3]&&(t=t.slice(0,3)+t.slice(4)),o("USLT",t)}r.genre&&o("TCON",r.genre+""),r.encoder&&o("TSSE",r.encoder),r.composer&&o("TCOM",r.composer),r.encodedBy&&o("TENC",r.encodedBy),r.language&&o("TLAN",r.language),r.performer&&o("TPE3",r.performer),r.publisher&&o("TPUB",r.publisher),r.compilation&&o("TCMP",r.compilation),r.creationTime&&o("TDEN",r.creationTime),r.albumSort&&o("TSOA",r.albumSort),r.artistSort&&o("TSOP",r.artistSort),r.titleSort&&o("TSOT",r.titleSort),r.grouping&&o("TIT1",r.grouping),i<10&&(i=10);const f=0|Number(t.getPos()-a&0xffffffffn);i>268435455-f&&(i=268435455-f),t.writeBuffer(new Uint8Array(i).fill(0)),a=t.getPos(),t.seek(s),function(t,e){t.writeUint8(e>>21&127),t.writeUint8(e>>14&127),t.writeUint8(e>>7&127),t.writeUint8(127&e)}(t,f),t.seek(a)}},31608:(t,e,i)=>{i.d(e,{FN:()=>a,W8:()=>r,c1:()=>n});const r=100,n=128,a=156},43607:(t,e,i)=>{function r(t){return t>0?t:-t}function n(t,e){return t>e?t:e}function a(t,e){return t>e?e:t}i.d(e,{T9:()=>n,jk:()=>a,tn:()=>r})}}]);